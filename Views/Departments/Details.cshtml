@model MessageForAzarab.Models.Department

@{
    ViewData["Title"] = "جزئیات دپارتمان";
}

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 text-gray-800 mb-0">
            <i class="bi bi-info-circle me-2"></i>@ViewData["Title"]
        </h1>
        <div>
            <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-primary" data-bs-toggle="tooltip" data-bs-placement="top" title="ویرایش دپارتمان">
                <i class="bi bi-pencil-square me-1"></i> ویرایش
            </a>
            <a asp-action="Index" class="btn btn-outline-secondary ms-2" data-bs-toggle="tooltip" data-bs-placement="top" title="بازگشت به لیست">
                <i class="bi bi-arrow-right"></i> بازگشت به لیست
            </a>
        </div>
    </div>
    
    <div class="row">
        <div class="col-lg-12">
            <div class="card shadow border-0 mb-4">
                <div class="card-header py-3 bg-gradient-primary-to-secondary">
                    <h6 class="m-0 fw-bold text-white">اطلاعات دپارتمان</h6>
                </div>
                <div class="card-body p-4">
                    <div class="row">
                        <div class="col-md-8">
                            <dl class="row">
                                <dt class="col-sm-3 text-end fw-bold">نام دپارتمان:</dt>
                                <dd class="col-sm-9 fs-5">@Model.Name</dd>
                                
                                <dt class="col-sm-3 text-end fw-bold">توضیحات:</dt>
                                <dd class="col-sm-9">
                                    @if (string.IsNullOrEmpty(Model.Description))
                                    {
                                        <span class="text-muted fst-italic">بدون توضیحات</span>
                                    }
                                    else
                                    {
                                        @Model.Description
                                    }
                                </dd>
                                
                                <dt class="col-sm-3 text-end fw-bold">تاریخ ایجاد:</dt>
                                <dd class="col-sm-9">
                                    <span class="badge bg-light text-dark">
                                        <i class="bi bi-calendar-date me-1"></i>
                                        @(Model.CreatedAt?.ToString("yyyy/MM/dd HH:mm") ?? "نامشخص")
                                    </span>
                                </dd>
                            </dl>
                        </div>
                        <div class="col-md-4 text-center">
                            <div class="border rounded-3 p-4 bg-light">
                                <div class="avatar avatar-lg bg-primary-soft rounded-circle mb-3">
                                    <i class="bi bi-building fs-1 text-primary"></i>
                                </div>
                                <h5 class="fw-bold">@Model.Name</h5>
                                <div class="mt-3">
                                    <span class="badge bg-info rounded-pill px-3 py-2">
                                        <i class="bi bi-folder me-1"></i>
                                        تعداد پروژه‌ها: @(Model.Projects?.Count ?? 0)
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- بخش پروژه‌های مرتبط -->
    <div class="card shadow border-0 mb-4">
        <div class="card-header py-3 d-flex justify-content-between align-items-center bg-light">
            <h6 class="m-0 fw-bold text-primary">
                <i class="bi bi-folder me-2"></i>پروژه‌های این دپارتمان
            </h6>
            <a asp-controller="Projects" asp-action="Create" asp-route-departmentId="@Model.Id" class="btn btn-success btn-sm" data-bs-toggle="tooltip" data-bs-placement="top" title="افزودن پروژه جدید">
                <i class="bi bi-plus-lg me-1"></i> افزودن پروژه
            </a>
        </div>
        <div class="card-body p-0">
            @if (Model.Projects != null && Model.Projects.Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover align-middle" id="projectsTable" width="100%" cellspacing="0">
                        <thead class="table-light">
                            <tr>
                                <th class="ps-4">عنوان پروژه</th>
                                <th>کد پروژه</th>
                                <th>وضعیت</th>
                                <th>تاریخ شروع</th>
                                <th class="text-center">عملیات</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var project in Model.Projects)
                            {
                                <tr>
                                    <td class="ps-4 fw-medium">@project.Name</td>
                                    <td><span class="badge bg-secondary bg-opacity-10 text-secondary">@project.ProjectCode</span></td>
                                    <td>
                                        @if (project.IsActive)
                                        {
                                            <span class="badge bg-success rounded-pill">فعال</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary rounded-pill">غیرفعال</span>
                                        }
                                    </td>
                                    <td>
                                        <i class="bi bi-calendar-date text-muted me-1"></i>
                                        @(project.StartDate?.ToString("yyyy/MM/dd") ?? "نامشخص")
                                    </td>
                                    <td class="text-center">
                                        <a asp-controller="Projects" asp-action="Details" asp-route-id="@project.Id" class="btn btn-info btn-sm rounded-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="مشاهده جزئیات">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                        <a asp-controller="Projects" asp-action="Edit" asp-route-id="@project.Id" class="btn btn-primary btn-sm rounded-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="ویرایش پروژه">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="alert alert-info m-4">
                    <i class="bi bi-info-circle me-2"></i> هیچ پروژه‌ای برای این دپارتمان تعریف نشده است.
                </div>
            }
        </div>
    </div>
    
    <!-- بخش کاربران مرتبط -->
    <div class="card shadow border-0 mb-4">
        <div class="card-header py-3 d-flex justify-content-between align-items-center bg-light">
            <h6 class="m-0 fw-bold text-primary">
                <i class="bi bi-people me-2"></i>کاربران این دپارتمان
            </h6>
            <a asp-action="ManageUsers" asp-route-id="@Model.Id" class="btn btn-primary btn-sm" data-bs-toggle="tooltip" data-bs-placement="top" title="مدیریت کاربران دپارتمان">
                <i class="bi bi-gear me-1"></i> مدیریت کاربران
            </a>
        </div>
        <div class="card-body p-0">
            @if (ViewBag.DepartmentUsers != null && ViewBag.DepartmentUsers.Count > 0)
            {
                <div class="table-responsive">
                    <table class="table table-hover align-middle" id="usersTable" width="100%" cellspacing="0">
                        <thead class="table-light">
                            <tr>
                                <th class="ps-4">نام کامل</th>
                                <th>ایمیل</th>
                                <th>نوع کاربر</th>
                                <th>شماره تماس</th>
                                <th class="text-center">عملیات</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var user in ViewBag.DepartmentUsers)
                            {
                                <tr>
                                    <td class="ps-4 fw-medium">@user.FullName</td>
                                    <td><a href="mailto:@user.Email" class="text-decoration-none">@user.Email</a></td>
                                    <td><span class="badge bg-primary bg-opacity-10 text-primary">@user.UserType</span></td>
                                    <td>
                                        @if(!string.IsNullOrEmpty(user.PhoneNumber)) {
                                            <a href="tel:@user.PhoneNumber" class="text-decoration-none">
                                                <i class="bi bi-telephone me-1 text-muted"></i>@user.PhoneNumber
                                            </a>
                                        } else {
                                            <span class="text-muted fst-italic">ثبت نشده</span>
                                        }
                                    </td>
                                    <td class="text-center">
                                        <a href="#" class="btn btn-info btn-sm rounded-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="مشاهده پروفایل">
                                            <i class="bi bi-person"></i>
                                        </a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="alert alert-info m-4">
                    <i class="bi bi-info-circle me-2"></i> در حال حاضر هیچ کاربری به این دپارتمان اختصاص داده نشده است.
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(function() {
            // فعال‌سازی tooltip
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl)
            });
            
            // راه‌اندازی DataTable برای جداول
            if ($("#projectsTable tbody tr").length > 0) {
                $("#projectsTable").DataTable({
                    language: {
                        url: '/lib/datatables/Persian.json'
                    },
                    responsive: true,
                    order: [[3, 'desc']]
                });
            }
            
            if ($("#usersTable tbody tr").length > 0) {
                $("#usersTable").DataTable({
                    language: {
                        url: '/lib/datatables/Persian.json'
                    },
                    responsive: true
                });
            }
        });
    </script>
} 